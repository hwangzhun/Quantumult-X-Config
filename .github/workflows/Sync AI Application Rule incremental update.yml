name: 同步 AI.list 增量更新

on:
  schedule:
    - cron: '0 0 * * *' # 每天 00:00 时执行一次
  workflow_dispatch: # 手动触发

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
    # Checkout your own repository
    - name: Checkout Your Repository
      uses: actions/checkout@v3
      with:
        path: your-repo

    # Checkout the target repository
    - name: Checkout Target Repository
      uses: actions/checkout@v3
      with:
        repository: blackmatrix7/ios_rule_script
        path: target-repo

    # Incremental merge rules from the target files to your file, with line separation
    - name: Incremental Merge Rules
      run: |
        # 创建一个临时文件来存放新规则
        temp_file=$(mktemp)

        # 处理 OpenAI.list 增量添加并换行
        grep -Fxvf your-repo/rule/AI.list target-repo/rule/QuantumultX/OpenAI/OpenAI.list >> $temp_file

        # 在 OpenAI.list 和 Gemini.list 之间插入换行
        echo "" >> $temp_file

        # 处理 Gemini.list 增量添加并换行
        grep -Fxvf your-repo/rule/AI.list target-repo/rule/QuantumultX/Gemini/Gemini.list >> $temp_file

        # 如果有新的规则，才追加到 AI.list
        if [ -s $temp_file ]; then
          # 将新规则追加到已有的 AI.list 文件中，而不是覆盖
          cat $temp_file >> your-repo/rule/AI.list
          echo "" >> your-repo/rule/AI.list
        fi

    # 提交并将更改推送到您的存储库（如果有更改）
    - name: Commit and Push
      run: |
        cd your-repo
        git config --global user.name "GitHub Action"
        git config --global user.email "Action@github.com"
        
        # 拉取远程更改，解决冲突（如果有的话）
        git pull --rebase origin master

        # 提交更改
        git add rule/AI.list
        git commit -m "例行增量更新 AI.list" || echo "没有新的提交"

        # 推送更改
        git push https://x-access-token:${{ secrets.PAT }}@github.com/hwangzhun/Quantumult-X-Config.git

